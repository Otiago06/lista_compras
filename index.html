<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Compra Inteligente</title>
    <!-- Carrega Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;600;700&display=swap" rel="stylesheet">
    <!-- Ícones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- QuaggaJS para leitura de código de barras via câmera -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

    <style>
        /* Configuração de Fonte Padrão e Estilos Globais */
        :root {
            --primary: #4f46e5;
            /* Cor Secundária (verde) agora é referenciada diretamente no Tailwind, mas mantemos a variável por consistência: */
            --secondary: #10b981; 
            --background: #f8f8fb;
            --card: #ffffff;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: #333;
        }
        .container-app {
            min-height: 100vh;
        }
        /* Estilizando o scrollbar para mobile */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }
        ::-webkit-scrollbar-track { background: var(--background); }

        /* Estilo para destaque de valor */
        .total-item-value {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
            color: var(--primary);
        }

        /* Estilos específicos para o scanner QuaggaJS */
        #interactive-container {
            width: 100%;
            height: 250px; /* Altura fixa para a visualização da câmera */
            overflow: hidden;
            position: relative;
            background-color: #000;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        /* Ajuste para o vídeo do Quagga */
        #interactive-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #interactive-container canvas {
            display: none; /* Oculta o canvas padrão que o Quagga cria */
        }
        /* O canvas de overlay que desenha as caixas de detecção deve ser visível */
        #interactive-container > canvas.drawingBuffer {
            display: block !important; 
            position: absolute;
            top: 0;
            left: 0;
        }
        
        /* Classe para o dropdown */
        .dropdown-menu-visible {
            opacity: 1 !important;
            pointer-events: auto !important;
            transform: translateY(0) !important;
        }

    </style>
</head>
<body class="antialiased">

    <!-- Container Principal do Aplicativo -->
    <div id="app" class="container-app max-w-lg mx-auto bg-gray-50 shadow-2xl flex flex-col">

        <!-- Header -->
        <header class="bg-white p-4 shadow-lg sticky top-0 z-10">
            <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                <i data-lucide="shopping-cart" class="w-6 h-6 mr-2 text-indigo-600"></i>
                Minha Compra
            </h1>
            <p class="text-sm text-gray-500 mt-1">
                Controle de Gastos em Tempo Real 
                <span class="text-xs text-gray-400 ml-1">(v1.0.9)</span>
            </p>
        </header>

        <!-- Seção de Resumo (Total Gasto) -->
        <div class="p-4 bg-indigo-600 text-white shadow-xl">
            <div class="flex justify-between items-center">
                <span class="text-lg font-semibold uppercase">Total Atual:</span>
                <span id="grand-total-display" class="text-4xl font-extrabold">R$ 0,00</span>
            </div>
            <!-- Status do Armazenamento e Rede -->
            <p id="auth-status" class="text-xs mt-2 text-indigo-200">
                <!-- O status será atualizado via JavaScript -->
            </p>
        </div>

        <!-- Lista de Itens (Scrollable) -->
        <main class="flex-grow p-4 overflow-y-auto">
            <h2 class="text-xl font-semibold mb-3 text-gray-700">Itens no Carrinho</h2>
            <div id="shopping-list" class="space-y-3">
                <!-- Itens serão injetados aqui -->
                <div id="empty-state" class="text-center p-8 text-gray-500 bg-white border-2 border-dashed border-gray-300 rounded-xl">
                    <i data-lucide="inbox" class="w-8 h-8 mx-auto mb-2"></i>
                    <p class="font-medium">Sua lista está vazia.</p>
                    <p class="text-sm">Adicione o primeiro item usando o botão abaixo.</p>
                </div>
            </div>
        </main>

        <!-- Footer e Botões de Ação -->
        <footer class="p-4 bg-white border-t border-gray-200 sticky bottom-0 z-10">
            <div class="flex space-x-2">
                <!-- Botão Adicionar Item (Principal) -->
                <button id="add-item-btn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-150 transform hover:scale-[1.01] flex items-center justify-center focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                    <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i>
                    Adicionar Item
                </button>
                
                <!-- Dropdown de Ações (MENU) -->
                <div class="relative">
                    <!-- Botão que abre o Dropdown -->
                    <button id="menu-toggle-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-4 rounded-xl shadow-md transition duration-150 flex items-center justify-center focus:outline-none focus:ring-4 focus:ring-gray-400 focus:ring-opacity-50">
                        <i data-lucide="menu" class="w-5 h-5"></i>
                    </button>
                    
                    <!-- Menu Suspenso -->
                    <div id="action-menu" class="absolute bottom-full right-0 mb-2 w-64 bg-white rounded-xl shadow-2xl ring-1 ring-black ring-opacity-5 opacity-0 pointer-events-none transition duration-150 transform translate-y-2 origin-bottom-right">
                        <div class="py-1">
                            <!-- Opção 1: Exportar CSV -->
                            <button id="export-csv-btn" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                <i data-lucide="file-text" class="w-4 h-4 mr-2 text-indigo-500"></i>
                                Exportar para CSV
                            </button>
                            <!-- Opção 2: Comparador de Preços (Link Externo) -->
                            <a href="https://otiago06.github.io/comparador_precos_ph/" target="_blank" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-100 flex items-center border-t border-gray-100">
                                <i data-lucide="line-chart" class="w-4 h-4 mr-2 text-green-500"></i>
                                Comparador de preços PH
                            </a>
                            <!-- Opção 3: Limpar Todos os Dados (NOVO) -->
                            <button id="clear-data-btn" class="w-full text-left px-4 py-3 text-sm text-red-600 hover:bg-red-50 flex items-center border-t border-gray-100">
                                <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                                Limpar Todos os Dados
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Crédito no Rodapé -->
            <p class="text-xs text-center text-gray-400 mt-3">
                Desenvolvido por Tiago Oliveira
            </p>
        </footer>

    </div>

    <!-- MODAL para Adicionar/Editar Item (Inalterado) -->
    <div id="item-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl transform transition-transform duration-300 scale-95 opacity-0" id="item-modal-content">
            
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4" id="modal-title">Adicionar Novo Item</h3>
                
                <!-- Passo 1: Leitura/Entrada do Código de Barras/Nome -->
                <div id="step-scan" class="space-y-4">

                    <!-- Container para o Scan da Câmera (QuaggaJS) -->
                    <div id="interactive-container" class="hidden">
                        <!-- O stream de vídeo será injetado aqui pelo Quagga -->
                    </div>
                    
                    <!-- Botão de Iniciar/Parar Leitor (Corrigido para usar bg-green-600) -->
                    <button id="start-scan-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-150 shadow-md flex items-center justify-center">
                        <i data-lucide="camera" class="w-5 h-5 inline-block mr-2" id="scan-icon"></i>
                        <span id="scan-text">Iniciar Leitor de Código de Barras</span>
                    </button>

                    <div class="relative flex items-center py-2">
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="flex-shrink mx-4 text-gray-400 text-sm">OU</span>
                        <div class="flex-grow border-t border-gray-300"></div>
                    </div>

                    <label class="block text-sm font-medium text-gray-700">
                        Insira o Código (EAN13) / Nome Manualmente
                    </label>
                    <div class="flex">
                        <input type="text" id="barcode-input" placeholder="Ex: 789... (EAN) ou 'Arroz'" class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-indigo-500 focus:border-indigo-500" />
                        
                        <!-- BOTÃO DE BUSCA VISÍVEL -->
                        <button id="submit-barcode-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold p-3 rounded-r-lg shadow-md transition duration-150 flex items-center justify-center disabled:bg-indigo-300">
                            <i data-lucide="search" class="w-5 h-5"></i>
                            <span id="scan-loading" class="hidden ml-2 h-5 w-5 border-2 border-t-2 border-white border-t-indigo-200 rounded-full animate-spin"></span>
                        </button>
                    </div>

                    <p id="scan-feedback" class="text-sm text-center text-gray-500"></p>
                    
                    <p class="text-xs text-gray-500 mt-2">
                        Se o produto for encontrado online, o nome será preenchido. Se falhar ou estiver offline, você poderá preencher os detalhes manualmente.
                    </p>
                </div>

                <!-- Passo 2: Detalhes do Produto (Oculto inicialmente) -->
                <div id="step-details" class="space-y-4 hidden mt-4">
                    <h4 class="text-lg font-semibold text-indigo-600 border-b pb-2 mb-4">Detalhes do Item</h4>

                    <input type="hidden" id="item-id-hidden">

                    <label class="block text-sm font-medium text-gray-700">Nome/Descrição do Produto</label>
                    <input type="text" id="product-name-input" placeholder="Ex: Café Torrado 500g" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required />
                    
                    <div class="flex space-x-3">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700">Quantidade</label>
                            <!-- Placeholder 1 para sugerir a quantidade mais comum -->
                            <input type="number" id="quantity-input" min="1" placeholder="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required />
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700">Valor Unitário (R$)</label>
                            <!-- Placeholder 0,00 para sugestão, campo limpo para digitação -->
                            <input type="text" inputmode="decimal" id="price-input" placeholder="0,00" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required />
                        </div>
                    </div>
                    
                    <button id="save-item-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-150 shadow-md">
                        <i data-lucide="check-circle" class="w-5 h-5 inline-block mr-2"></i>
                        Adicionar à Lista
                    </button>
                </div>
            </div>

            <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end">
                <button id="close-modal-btn" class="text-gray-600 hover:text-gray-800 font-medium px-4 py-2 rounded-lg">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL para CONFIRMAÇÃO de Limpeza de Dados -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm hidden items-center justify-center p-4 z-[60] transition-opacity duration-300">
        <div class="bg-white rounded-2xl w-full max-w-xs shadow-2xl transform transition-transform duration-300 scale-95 opacity-0" id="confirmation-modal-content">
            <div class="p-6 text-center">
                <i data-lucide="alert-triangle" class="w-12 h-12 mx-auto mb-4 text-red-500"></i>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Confirmação de Exclusão</h3>
                <p class="text-sm text-gray-600">Tem certeza que deseja apagar **TODOS** os dados da lista de compras?</p>
                <p class="text-xs text-red-500 font-medium mt-1">Esta ação é irreversível.</p>
            </div>

            <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3">
                <button id="cancel-clear-btn" class="text-gray-600 hover:bg-gray-200 font-medium px-4 py-2 rounded-lg transition">
                    Cancelar
                </button>
                <button id="confirm-clear-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition">
                    <i data-lucide="trash-2" class="w-4 h-4 inline-block mr-1"></i>
                    Excluir Tudo
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast/Mensagem de Feedback -->
    <div id="toast" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 p-3 bg-gray-800 text-white text-sm rounded-lg shadow-xl opacity-0 transition-opacity duration-300 pointer-events-none z-50">
        Mensagem de Teste
    </div>


    <!-- JAVASCRIPT LOCAL STORAGE LOGIC & QUAGGA INTEGRATION -->
    <script type="module">
        
        // --- CONSTANTES ---
        const LOCAL_STORAGE_KEY = 'minhaCompraList';
        
        // --- ELEMENTOS UI ---
        const listContainer = document.getElementById('shopping-list');
        const totalDisplay = document.getElementById('grand-total-display');
        const authStatus = document.getElementById('auth-status');
        const addItemBtn = document.getElementById('add-item-btn');
        
        // ELEMENTOS DO MENU
        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        const actionMenu = document.getElementById('action-menu');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const clearDataBtn = document.getElementById('clear-data-btn');

        // ELEMENTOS DO MODAL ITEM
        const modal = document.getElementById('item-modal');
        const modalContent = document.getElementById('item-modal-content');
        const modalTitle = document.getElementById('modal-title');
        const stepScan = document.getElementById('step-scan');
        const stepDetails = document.getElementById('step-details');
        const barcodeInput = document.getElementById('barcode-input');
        const startScanBtn = document.getElementById('start-scan-btn'); 
        const scanIcon = document.getElementById('scan-icon'); 
        const scanText = document.getElementById('scan-text'); 
        const submitBarcodeBtn = document.getElementById('submit-barcode-btn'); 
        const interactiveContainer = document.getElementById('interactive-container');
        const scanFeedback = document.getElementById('scan-feedback');
        
        const productNameInput = document.getElementById('product-name-input');
        const quantityInput = document.getElementById('quantity-input');
        const priceInput = document.getElementById('price-input');
        const saveItemBtn = document.getElementById('save-item-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const itemIdHidden = document.getElementById('item-id-hidden');
        const toastElement = document.getElementById('toast');
        const emptyState = document.getElementById('empty-state');
        const scanLoading = document.getElementById('scan-loading');
        
        // NOVO: ELEMENTOS DO MODAL DE CONFIRMAÇÃO
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationModalContent = document.getElementById('confirmation-modal-content');
        const confirmClearBtn = document.getElementById('confirm-clear-btn');
        const cancelClearBtn = document.getElementById('cancel-clear-btn');


        // Estado do Scanner
        let isScannerRunning = false;


        // --- FUNÇÕES DE UTILIDADE ---

        /** Formata um número para o padrão monetário brasileiro. */
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        /** Exibe uma notificação Toast. */
        function showToast(message) {
            toastElement.textContent = message;
            toastElement.classList.remove('opacity-0', 'pointer-events-none');
            toastElement.classList.add('opacity-100');
            setTimeout(() => {
                toastElement.classList.add('opacity-0');
                toastElement.classList.remove('opacity-100');
                setTimeout(() => {
                     toastElement.classList.add('pointer-events-none');
                }, 300);
            }, 3000);
        }

        /** * Alterna a visibilidade do menu de ações (dropdown).
         * @param {boolean} [show] Força o estado (true para mostrar, false para esconder).
         */
        function toggleMenu(show) {
            const isVisible = actionMenu.classList.contains('dropdown-menu-visible');

            if (show === false || isVisible) {
                // Esconder
                actionMenu.classList.remove('dropdown-menu-visible');
            } else {
                // Mostrar
                actionMenu.classList.add('dropdown-menu-visible');
            }
        }
        
        /** Gera um ID de documento único. */
        function generateId() {
            return 'item-' + Date.now().toString(36) + Math.random().toString(36).substring(2, 5);
        }

        /**
         * Atualiza o texto do status de conexão na UI.
         */
        function updateNetworkStatus() {
            if (navigator.onLine) {
                authStatus.innerHTML = '<i data-lucide="wifi" class="w-4 h-4 inline-block mr-1"></i> Modo Local (Conectado)';
            } else {
                authStatus.innerHTML = '<i data-lucide="wifi-off" class="w-4 h-4 inline-block mr-1"></i> Modo Offline Ativo (Dados Locais)';
            }
            lucide.createIcons();
        }

        /**
         * Busca o produto por código de barras (EAN13) usando a API Open Food Facts.
         */
        async function fetchProductByBarcode(barcode) {
            const normalizedBarcode = String(barcode).trim();
            const apiUrl = `https://world.openfoodfacts.org/api/v0/product/${normalizedBarcode}.json`;

            if (!navigator.onLine) {
                throw new Error("offline");
            }

            try {
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    return null; 
                }

                const data = await response.json();

                if (data.status === 1 && data.product && data.product.product_name) {
                    const productName = data.product.product_name_pt || data.product.product_name; 
                    const unitPrice = 0.00; // API não fornece preço de mercado
                    return { name: productName, unitPrice: unitPrice };
                } else {
                    return null;
                }

            } catch (error) {
                console.error("Erro na busca de produto:", error);
                throw new Error("network_error");
            }
        }

        // --- FUNÇÕES QUAGGAJS (CAMERA SCANNER) ---

        /** Inicia o scanner de câmera. */
        function startScanner() {
            if (isScannerRunning) return;

            // 1. Atualiza o botão para o estado "Parar" (USANDO CLASSES DIRETAS DO TAILWIND)
            startScanBtn.classList.add('bg-red-500', 'hover:bg-red-600');
            startScanBtn.classList.remove('bg-green-600', 'hover:bg-green-700'); 
            scanText.textContent = 'Parar Leitor';
            scanIcon.setAttribute('data-lucide', 'square');
            lucide.createIcons();

            // 2. Mostra o container de vídeo
            interactiveContainer.classList.remove('hidden');
            scanFeedback.textContent = 'Aponte a câmera para o código de barras...';

            Quagga.init({
                // OTIMIZAÇÃO: Adiciona workers para processamento paralelo e frequência de processamento
                workers: 4, 
                frequency: 10,
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: interactiveContainer,
                    // OTIMIZAÇÃO: Aumenta a resolução mínima para forçar melhor qualidade/foco
                    constraints: {
                        width: { min: 640 }, 
                        height: { min: 480 },
                        facingMode: "environment" 
                    },
                },
                // OTIMIZAÇÃO: Configurações explícitas do localizador para melhor detecção
                locator: { 
                    patchSize: 'medium', 
                    halfSample: true 
                },
                decoder: {
                    readers: ["ean_reader", "ean_8_reader", "upc_reader", "upc_e_reader"],
                },
                locate: true // Garante que o Quagga tente localizar o código
            }, function (err) {
                if (err) {
                    console.error("Erro ao inicializar Quagga:", err);
                    showToast("Erro ao iniciar a câmera. Verifique permissões ou tente inserir manualmente.");
                    stopScanner(); // Garante o reset do estado e botão
                    return
                }
                Quagga.start();
                isScannerRunning = true;
                scanFeedback.textContent = 'Câmera iniciada. Buscando código...';
            });

            Quagga.onDetected(onDetected);

            // Adiciona listener para desenhar a caixa de detecção (feedback visual)
            Quagga.onProcessed(function(result) {
                var drawingCtx = Quagga.canvas.ctx.overlay,
                    drawingCanvas = Quagga.canvas.dom.overlay;

                if (result) {
                    // Limpa a área
                    drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                    
                    // Desenha o box do código detectado
                    if (result.box) {
                        Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "blue", lineWidth: 2});
                    }

                    // Desenha a linha de detecção (central)
                    if (result.codeResult && result.codeResult.code) {
                        Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: "red", lineWidth: 3});
                    }
                }
            });
        }

        /** Para o scanner de câmera. */
        function stopScanner() {
            if (isScannerRunning) {
                Quagga.stop();
                isScannerRunning = false;
                
                // 1. Atualiza o botão para o estado "Iniciar" (USANDO CLASSES DIRETAS DO TAILWIND)
                startScanBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                startScanBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                scanText.textContent = 'Iniciar Leitor de Código de Barras';
                scanIcon.setAttribute('data-lucide', 'camera');
                lucide.createIcons();

                // 2. Esconde o container de vídeo
                interactiveContainer.classList.add('hidden');
                scanFeedback.textContent = '';
            }
        }

        /** Callback de detecção de código de barras. */
        async function onDetected(result) {
            stopScanner(); // Para a câmera imediatamente após a primeira detecção

            const code = result.codeResult.code;
            barcodeInput.value = code; // Preenche o campo de input
            scanFeedback.textContent = `Código detectado: ${code}`;
            
            // Chama a função de busca/processamento
            await processBarcodeOrManualEntry(code);
        }

        /** Processa o código/nome e avança para a tela de detalhes. */
        async function processBarcodeOrManualEntry(input) {
            const value = String(input).trim();
            
            if (!value) {
                showToast("Nenhum código ou nome foi inserido.");
                barcodeInput.focus();
                return;
            }

            // Ativa o loading e desabilita o botão de busca
            submitBarcodeBtn.disabled = true;
            scanLoading.classList.remove('hidden');
            
            let product = null;
            let errorType = null;

            // Tenta a busca se o valor parece um EAN (apenas números e pelo menos 8 dígitos)
            const isEanLike = value.length >= 8 && /^\d+$/.test(value);

            if (isEanLike) {
                try {
                    product = await fetchProductByBarcode(value);
                } catch (e) {
                    errorType = e.message;
                }
            } else {
                // Se for um nome digitado (não parece EAN), avança diretamente
                productNameInput.value = value;
            }

            // Desativa o loading
            submitBarcodeBtn.disabled = false;
            scanLoading.classList.add('hidden');

            // Transição para o Passo 2: Detalhes
            stepScan.classList.add('hidden');
            stepDetails.classList.remove('hidden');

            // LIMPAR AMBOS OS CAMPOS de valor e quantidade para usar PLACEHOLDERS
            priceInput.value = ''; 
            quantityInput.value = ''; 


            if (errorType === 'offline') {
                // Se estiver offline
                modalTitle.textContent = 'Modo Offline';
                productNameInput.value = value;
                priceInput.focus();
                showToast("Você está OFFLINE. Produto não consultado. Informe os detalhes manualmente.");
                return; 
            }
            
            if (product) {
                // Produto Encontrado Online
                modalTitle.textContent = 'Produto Encontrado!';
                productNameInput.value = product.name;
                saveItemBtn.textContent = 'Adicionar à Lista';
                priceInput.focus();
                showToast(`Produto encontrado: ${product.name}. Por favor, insira o preço.`);
            } else {
                // Produto NÃO Encontrado (Online, erro de API ou nome digitado)
                if (isEanLike && errorType === 'network_error') {
                     showToast("Erro de rede/servidor ao buscar o EAN. Informe os detalhes manualmente.");
                } else if (isEanLike) {
                     showToast("Código de barras não encontrado na base. Informe os detalhes manualmente.");
                } else {
                     showToast("Por favor, informe os detalhes do produto manualmente.");
                }

                modalTitle.textContent = 'Produto Novo';
                productNameInput.value = value;
                priceInput.focus();
            }
        }


        // --- FUNÇÕES DE ARMAZENAMENTO LOCAL (LOCALSTORAGE) ---

        function loadListFromLocal() {
            try {
                const json = localStorage.getItem(LOCAL_STORAGE_KEY);
                return json ? JSON.parse(json) : [];
            } catch (e) {
                console.error("Erro ao carregar lista do localStorage:", e);
                showToast("Erro ao carregar dados locais. Limpando a lista...");
                return [];
            }
        }

        function saveListToLocal(items) {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(items));
                renderList(items); 
            } catch (e) {
                console.error("Erro ao salvar lista no localStorage:", e);
                showToast("Erro ao salvar dados localmente. Memória cheia?");
            }
        }

        /**
         * Limpa todos os dados do localStorage da aplicação.
         */
        function clearAllDataConfirmed() {
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            renderList([]);
            showToast("⚠️ Todos os dados da lista foram excluídos!");
            closeConfirmationModal(); // Fecha o modal após a exclusão
            toggleMenu(false); // Fecha o menu principal
        }

        function exportList(listItems) {
            if (!listItems || listItems.length === 0) {
                showToast("A lista está vazia para exportar.");
                return;
            }

            let csv = "Produto,Valor Unitário,Quantidade,Valor Total\n";

            listItems.forEach(item => {
                const total = item.unitPrice * item.quantity;
                const row = [
                    `"${item.name.replace(/"/g, '""')}"`, 
                    item.unitPrice.toFixed(2).replace('.', ','), 
                    item.quantity,
                    total.toFixed(2).replace('.', ',')
                ].join(",");
                csv += row + "\n";
            });

            const grandTotal = listItems.reduce((acc, item) => acc + (item.unitPrice * item.quantity), 0);
            csv += `\nTOTAL GERAL:,${grandTotal.toFixed(2).replace('.', ',')}\n`;

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            
            const date = new Date().toISOString().slice(0, 10);
            link.setAttribute("download", `lista_de_compras_${date}.csv`);
            
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast("Lista exportada com sucesso como CSV!");
        }

        // --- FUNÇÕES DE MODAL ---

        function closeModal() {
            stopScanner(); 
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                
                // Resetar inputs para vazio, usando placeholder
                barcodeInput.value = '';
                productNameInput.value = '';
                quantityInput.value = ''; 
                priceInput.value = ''; 
                itemIdHidden.value = '';

                // Voltar ao passo de Scan
                modalTitle.textContent = 'Adicionar Novo Item';
                stepDetails.classList.add('hidden');
                stepScan.classList.remove('hidden');
            }, 300);
        }

        function openModal(item = null) {
            modal.classList.add('flex');
            modal.classList.remove('hidden');
            
            if (item) {
                modalTitle.textContent = 'Editar Item';
                itemIdHidden.value = item.id;
                productNameInput.value = item.name;
                quantityInput.value = item.quantity;
                // Ao editar, DEVE preencher o campo com o valor existente
                priceInput.value = item.unitPrice.toFixed(2).replace('.', ',');
                saveItemBtn.textContent = 'Atualizar Item';
                
                stepScan.classList.add('hidden');
                stepDetails.classList.remove('hidden');
            } else {
                modalTitle.textContent = 'Adicionar Novo Item';
                saveItemBtn.textContent = 'Adicionar à Lista';

                // Certifica-se de que os inputs estejam vazios ao abrir novo item
                quantityInput.value = '';
                priceInput.value = '';
                
                // Começa no passo de Scan
                stepScan.classList.remove('hidden');
                stepDetails.classList.add('hidden');
            }

            setTimeout(() => {
                 modalContent.classList.add('scale-100', 'opacity-100');
                 modalContent.classList.remove('scale-95', 'opacity-0');
                 if (item) {
                    productNameInput.focus();
                 } else {
                    barcodeInput.focus();
                 }
            }, 50);
        }
        
        // NOVO: Abre o modal de confirmação
        function openConfirmationModal() {
            confirmationModal.classList.add('flex');
            confirmationModal.classList.remove('hidden');
            setTimeout(() => {
                confirmationModalContent.classList.add('scale-100', 'opacity-100');
                confirmationModalContent.classList.remove('scale-95', 'opacity-0');
            }, 50);
            toggleMenu(false); // Fecha o menu de ações
        }
        
        // NOVO: Fecha o modal de confirmação
        function closeConfirmationModal() {
            confirmationModalContent.classList.remove('scale-100', 'opacity-100');
            confirmationModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                confirmationModal.classList.add('hidden');
                confirmationModal.classList.remove('flex');
            }, 300);
        }


        function renderList(listItems = []) {
            let grandTotal = 0;
            listContainer.innerHTML = '';
            
            if (listItems.length === 0) {
                emptyState.classList.remove('hidden');
                totalDisplay.textContent = formatCurrency(0);
            } else {
                emptyState.classList.add('hidden');
            }

            listItems.forEach(item => {
                const total = item.unitPrice * item.quantity;
                grandTotal += total;

                const itemHtml = `
                    <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-indigo-500 flex justify-between items-center transition duration-150 ease-in-out hover:bg-indigo-50">
                        <div class="flex-1 min-w-0 pr-4">
                            <p class="text-lg font-bold text-gray-900 truncate">${item.name}</p>
                            <p class="text-sm text-gray-500 mt-0.5">
                                ${formatCurrency(item.unitPrice)}/unidade x ${item.quantity} ${item.quantity > 1 ? 'unidades' : 'unidade'}
                            </p>
                        </div>
                        <div class="text-right flex flex-col items-end">
                            <p class="total-item-value">${formatCurrency(total)}</p>
                            <div class="flex space-x-2 mt-2">
                                <button data-id="${item.id}" class="edit-item-btn text-indigo-500 hover:text-indigo-700 p-1 rounded-full hover:bg-indigo-100 transition" title="Editar">
                                    <i data-lucide="square-pen" class="w-4 h-4"></i>
                                </button>
                                <button data-id="${item.id}" class="delete-item-btn text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition" title="Excluir">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', itemHtml);
            });
            
            totalDisplay.textContent = formatCurrency(grandTotal);
            lucide.createIcons();
            
            document.querySelectorAll('.edit-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    const itemToEdit = loadListFromLocal().find(i => i.id === id);
                    if (itemToEdit) { openModal(itemToEdit); }
                });
            });

            document.querySelectorAll('.delete-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    deleteItem(id);
                });
            });
        }
        
        async function saveItem(newItemData) {
            let currentItems = loadListFromLocal();
            const isEditing = !!newItemData.id;
            
            if (isEditing) {
                const index = currentItems.findIndex(item => item.id === newItemData.id);
                if (index !== -1) { currentItems[index] = newItemData; } else {
                    newItemData.id = generateId();
                    currentItems.push(newItemData);
                }
            } else {
                newItemData.id = generateId();
                currentItems.push(newItemData);
            }

            saveListToLocal(currentItems);
            showToast(isEditing ? "Item atualizado com sucesso!" : "Item adicionado com sucesso!");
            closeModal();
        }
        
        function deleteItem(itemId) {
            let currentItems = loadListFromLocal();
            const updatedItems = currentItems.filter(item => item.id !== itemId);
            saveListToLocal(updatedItems);
            showToast("Item removido da lista.");
        }

        function initializeLocalApp() {
            const initialItems = loadListFromLocal();
            renderList(initialItems);

            updateNetworkStatus();

            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
        }


        // --- LISTENERS DE EVENTOS ---

        addItemBtn.addEventListener('click', () => openModal());
        closeModalBtn.addEventListener('click', () => closeModal());
        
        // Listener para o botão de toggle do menu
        menuToggleBtn.addEventListener('click', (e) => {
            e.stopPropagation(); 
            toggleMenu();
        });

        // Listener para fechar o menu ao clicar em qualquer lugar fora dele
        document.addEventListener('click', (e) => {
            if (actionMenu.classList.contains('dropdown-menu-visible')) {
                // Se o clique não foi no botão de toggle NEM no próprio menu
                if (!menuToggleBtn.contains(e.target) && !actionMenu.contains(e.target)) {
                    toggleMenu(false);
                }
            }
        });

        // Listener para Exportar para CSV (nova ID no menu)
        exportCsvBtn.addEventListener('click', () => {
            const listItems = loadListFromLocal();
            exportList(listItems);
            toggleMenu(false); // Fecha o menu após a ação
        });
        
        // ATUALIZADO: Listener para Limpar Dados (Abre o modal de confirmação)
        clearDataBtn.addEventListener('click', openConfirmationModal);
        
        // NOVO: Listener de confirmação no modal
        confirmClearBtn.addEventListener('click', clearAllDataConfirmed);
        
        // NOVO: Listener de cancelamento no modal
        cancelClearBtn.addEventListener('click', closeConfirmationModal);


        // Botão de Scan agora alterna entre iniciar e parar
        startScanBtn.addEventListener('click', () => {
            // Limpa o campo para o próximo scan ou entrada manual
            barcodeInput.value = '';

            if (isScannerRunning) {
                stopScanner();
            } else {
                startScanner();
            }
        });

        // O botão de busca (manual/online)
        submitBarcodeBtn.addEventListener('click', async () => {
            const input = barcodeInput.value;
            await processBarcodeOrManualEntry(input);
        });
        
        saveItemBtn.addEventListener('click', () => {
            const name = productNameInput.value.trim();
            
            // LÓGICA DE QUANTIDADE: Assume 1 se o campo estiver vazio, caso contrário, tenta parsear
            let quantityValue = quantityInput.value.trim();
            // AQUI: Se o campo for vazio, a quantidade é 1. Caso contrário, tenta converter.
            let quantity = quantityValue ? parseInt(quantityValue) : 1; 

            // Converte o valor de entrada (com vírgula) para um float (com ponto)
            const priceRaw = priceInput.value.trim();
            const unitPrice = parseFloat(priceRaw.replace(',', '.')); 
            const existingId = itemIdHidden.value;
            
            // --- VALIDAÇÃO APRIMORADA ---
            if (!name) {
                showToast("O campo Nome/Descrição é obrigatório.");
                productNameInput.focus();
                return;
            }
            
            if (isNaN(unitPrice) || unitPrice <= 0) {
                showToast("O Valor Unitário deve ser um número positivo (use vírgula).");
                priceInput.focus();
                return;
            }

            // Garante que mesmo que o usuário tente digitar '0' ou '-1', o app impeça
            if (quantity <= 0) {
                showToast("A Quantidade deve ser um número positivo (se vazio, é 1).");
                quantityInput.focus();
                return;
            }
            // -----------------------------

            const itemData = {
                id: existingId || generateId(),
                name: name,
                unitPrice: unitPrice,
                quantity: quantity,
            };

            saveItem(itemData);
        });

        window.onload = () => {
            initializeLocalApp();
            lucide.createIcons();
        };

    </script>
</body>
</html>
